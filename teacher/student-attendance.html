<!DOCTYPE html>

<head>
   <meta charset="UTF-8">
   <title>Student List</title>
   <!-- Bootstrap CSS -->
   <link href="../lib/bootstrap.min.css" rel="stylesheet">
   <link rel="stylesheet" href="../style.css">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">

   <script src="../lib/vue@2.6.14.js"></script>
</head>

<body>
   <div id="app" class="container mt-5">
      <h1>শিক্ষার্থীদের তালিকা</h1>

      <div class="d-flex gap-3 mb-4 justify-content-between">
         <select v-model="classFilter" @change="fetchStudents" class="form-select shadow-none">
            <option value="">All Classes</option>
            <option v-for="className in classNames" :key="className._id" :value="className._id">{{ className.className
               }}</option>
         </select>
      </div>

      <ul class="list-group mb-3">
         <li class="list-group-item d-flex justify-content-between align-items-center"
            v-for="student in filteredStudents" :key="student._id">
            <span>
               {{ student.fullName }} - {{ student.age }}
            </span>
            <div>
               <label>
                  <input type="radio" checked="checked" :value="'Present'" v-model="student.attendanceStatus"
                     @change="updateAttendance(student)">
                  Present
               </label>
               <label>
                  <input type="radio" :value="'Absent'" v-model="student.attendanceStatus"
                     @change="updateAttendance(student)">
                  Absent
               </label>
               <label>
                  <input type="radio" :value="'Leave'" v-model="student.attendanceStatus"
                     @change="updateAttendance(student)">
                  Leave
               </label>
            </div>
         </li>
      </ul>
      <button @click="submitAttendance">Submit Attendance</button>
   </div>

   <script>
      new Vue({
         el: '#app',
         data: {
            students: [],
            filteredStudents: [],
            classFilter: '',
            classNames: null,
            token: '', // Initialize token variable
         },
         mounted() {
            this.token = localStorage.getItem('token'); // Retrieve token from localStorage
            if (!this.token) {
               // Handle case where token is not found in localStorage
               console.error('Token not found in localStorage');
               return;
            }

            this.fetchClasses();
            this.fetchStudents();
         },
         methods: {
            async fetchStudents() {
               try {
                  let url = 'https://madrasa-back.vercel.app/api/student/list';
                  if (this.classFilter) {
                     url += `?className=${encodeURIComponent(this.classFilter)}`;
                  }

                  const response = await fetch(url, {
                     method: 'GET',
                     headers: {
                        'Authorization': this.token,
                        'Content-Type': 'application/json',
                        // Add other headers as needed
                     },
                  });
                  const data = await response.json();
                  this.students = data.students.map(student => ({
                     ...student,
                     attendanceStatus: '' // Initialize attendance status for each student
                  }));
                  this.filteredStudents = this.students; // Initially set to all students
               } catch (error) {
                  console.error('Error fetching students:', error);
               }
            },
            async fetchClasses() {
               try {
                  const response = await fetch('https://madrasa-back.vercel.app/api/class/list', {
                     method: 'GET',
                     headers: {
                        'Authorization': this.token,
                        'Content-Type': 'application/json',
                        // Add other headers as needed
                     },
                  });
                  const data = await response.json();
                  this.classNames = data;
               } catch (error) {
                  console.error('Error fetching classes:', error);
               }
            },
            async updateAttendance(student) {
               try {
                  const response = await fetch('https://madrasa-back.vercel.app/api/attendance/update', {
                     method: 'POST',
                     headers: {
                        'Authorization': this.token,
                        'Content-Type': 'application/json',
                        // Add other headers as needed
                     },
                     body: JSON.stringify({
                        studentId: student._id,
                        classId: student.classId,
                        date: new Date().toISOString().split('T')[0], // Current date
                        status: student.attendanceStatus,
                     }),
                  });
                  const updatedData = await response.json();
                  console.log('Attendance Updated:', updatedData);
               } catch (error) {
                  console.error('Error updating attendance:', error);
               }
            },
            submitAttendance() {
               const attendanceRecords = this.students.map(student => ({
                  studentId: student._id,
                  classId: student.studentClass._id, // Assuming the classId is directly available in the student object
                  date: new Date().toISOString().split('T')[0], // Current date
                  status: student.attendanceStatus.toLowerCase() // Ensure status is in lowercase as specified
               }));

               const payload = { attendanceRecords };

               // API endpoint to submit attendance
               const apiUrl = 'http://localhost:3000/api/attendance/create-multiple'; // Replace with your actual API endpoint
               const token = localStorage.getItem('token'); // Retrieve the token from localStorage

               fetch(apiUrl, {
                  method: 'POST',
                  headers: {
                     'Authorization': `${token}`, // Include the retrieved token in the header
                     'Content-Type': 'application/json'
                     // Add other headers as needed
                  },
                  body: JSON.stringify(payload)
               })
                  .then(response => {
                     if (!response.ok) {
                        throw new Error('Network response was not ok');
                     }
                     return response.json();
                  })
                  .then(data => {
                     console.log('Attendance submitted successfully:', data);
                     alert('Attendance submitted successfully!');
                  })
                  .catch(error => {
                     console.error('There was a problem submitting attendance:', error);
                     alert('There was an error submitting attendance.');
                  });
            },

         }
      });
   </script>
</body>

</html>